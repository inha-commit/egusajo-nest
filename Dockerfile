FROM node:21-alpine

WORKDIR /usr/src/app

COPY . .

RUN npm install

RUN npm run build

# Get secret from git action
ARG DATABASE_HOST
ARG DATABASE_PORT
ARG DATABASE_USERNAME
ARG DATABASE_PASSWORD
ARG DATABASE_NAME
ARG JWT_SECRET
ARG ACCESS_TOKEN_EXPIRE
ARG REFRESH_TOKEN_EXPIRE
ARG S3_ACCESS_KEY
ARG S3_SECRET_KEY
ARG S3_BUCKET_NAME
ARG S3_REGION
ARG SLACK_BOT_TOKEN
ARG SLACK_NEW_USER_CHANNEL_ID
ARG SLACK_API_LATENCY_CHANNEL_ID
ARG SLACK_FATAL_ERROR_CHANNEL_ID
ARG REDIS_HOST
ARG REDIS_PORT
ARG REDIS_PASSWORD
ARG BASIC_PROFILE_IMAGE_SRC
ARG FCM_CREDENTIAL_TYPE
ARG FCM_CREDENTIAL_PROJECT_ID
ARG FCM_CREDENTIAL_PRIVATE_KEY_ID
ARG FCM_CREDENTIAL_CLIENT_EMAIL
ARG FCM_CREDENTIAL_CLIENT_ID
ARG FCM_CREDENTIAL_AUTH_URI
ARG FCM_CREDENTIAL_TOKEN_URI
ARG FCM_CREDENTIAL_AUTH_PROVIDER_CERT_URL
ARG FCM_CREDENTIAL_CLIENT_CERT_URL
ARG FCM_CREDENTIAL_UNIVERSE_DOMAIN
ARG FCM_CREDENTIAL_PRIVATE_KEY


# Copy secret to ENV
ENV NODE_ENV=production \
 DATABASE_HOST=$DATABASE_HOST \
 DATABASE_PORT=$DATABASE_PORT \
 DATABASE_USERNAME=$DATABASE_USERNAME \
 DATABASE_PASSWORD=$DATABASE_PASSWORD \
 DATABASE_NAME=$DATABASE_NAME \
 JWT_SECRET=$JWT_SECRET \
 ACCESS_TOKEN_EXPIRE=$ACCESS_TOKEN_EXPIRE \
 REFRESH_TOKEN_EXPIRE=$REFRESH_TOKEN_EXPIRE \
 S3_ACCESS_KEY=$S3_ACCESS_KEY \
 S3_SECRET_KEY=$S3_SECRET_KEY \
 S3_BUCKET_NAME=$S3_BUCKET_NAME \
 S3_REGION=$S3_REGION \
 SLACK_BOT_TOKEN=$SLACK_BOT_TOKEN \
 SLACK_NEW_USER_CHANNEL_ID=$SLACK_NEW_USER_CHANNEL_ID \
 SLACK_API_LATENCY_CHANNEL_ID=$SLACK_API_LATENCY_CHANNEL_ID \
 SLACK_FATAL_ERROR_CHANNEL_ID=$SLACK_FATAL_ERROR_CHANNEL_ID \
 REDIS_HOST=$REDIS_HOST \
 REDIS_PORT=$REDIS_PORT \
 REDIS_PASSWORD=$REDIS_PASSWORD \
 BASIC_PROFILE_IMAGE_SRC=$BASIC_PROFILE_IMAGE_SRC \
 FCM_CREDENTIAL_TYPE=$FCM_CREDENTIAL_TYPE \
 FCM_CREDENTIAL_PROJECT_ID=$FCM_CREDENTIAL_PROJECT_ID \
 FCM_CREDENTIAL_PRIVATE_KEY_ID=$FCM_CREDENTIAL_PRIVATE_KEY_ID \
 FCM_CREDENTIAL_CLIENT_EMAIL=$FCM_CREDENTIAL_CLIENT_EMAIL \
 FCM_CREDENTIAL_CLIENT_ID=$FCM_CREDENTIAL_CLIENT_ID \
 FCM_CREDENTIAL_AUTH_URI=$FCM_CREDENTIAL_AUTH_URI \
 FCM_CREDENTIAL_TOKEN_URI=$FCM_CREDENTIAL_TOKEN_URI \
 FCM_CREDENTIAL_AUTH_PROVIDER_CERT_URL=$FCM_CREDENTIAL_AUTH_PROVIDER_CERT_URL \
 FCM_CREDENTIAL_CLIENT_CERT_URL=$FCM_CREDENTIAL_CLIENT_CERT_URL \
 FCM_CREDENTIAL_UNIVERSE_DOMAIN=$FCM_CREDENTIAL_UNIVERSE_DOMAIN \
 FCM_CREDENTIAL_PRIVATE_KEY=$FCM_CREDENTIAL_PRIVATE_KEY

EXPOSE 3000

CMD ["node", "dist/main"]
